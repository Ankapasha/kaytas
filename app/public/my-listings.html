<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title data-i18n="my_listings">My Listings â€“ Kaytas</title>

  <!-- MAP -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f6f8;
      margin: 0;
      padding: 20px;
    }

    #langBox {
      text-align: right;
      margin-bottom: 15px;
    }

    #langSwitcher {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    h1 {
      text-align: center;
      margin-bottom: 25px;
    }

    .list-container {
      max-width: 950px;
      margin: 0 auto;
    }

    .listing-card {
      background: #fff;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .listing-card img {
      width: 130px;
      height: 95px;
      object-fit: cover;
      border-radius: 6px;
      background: #ddd;
    }

    .listing-info { flex: 1; }
    .listing-title { font-size: 18px; font-weight: bold; margin: 0; }
    .listing-meta { font-size: 14px; color: #666; margin-top: 4px; }

    .miniMap {
      width: 140px;
      height: 95px;
      border-radius: 6px;
      overflow: hidden;
    }

    .listing-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .listing-actions button {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .edit-btn { background: #1976d2; color: #fff; }
    .open-btn { background: #dddddd; }

    .empty-message {
      text-align: center;
      color: #666;
      padding: 40px;
      font-size: 18px;
    }

    #pagination {
      text-align: center;
      margin-top: 25px;
    }

    #pagination button {
      padding: 8px 12px;
      margin: 0 4px;
      background: #1976d2;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>

<body>

<!-- LANGUAGE -->
<div id="langBox">
  <select id="langSwitcher">
    <option value="en">ðŸ‡¬ðŸ‡§ English</option>
    <option value="bs">ðŸ‡·ðŸ‡¸ Serbian (Latin)</option>
    <option value="de">ðŸ‡©ðŸ‡ª Deutsch</option>
    <option value="fr">ðŸ‡«ðŸ‡· FranÃ§ais</option>
    <option value="es">ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
    <option value="it">ðŸ‡®ðŸ‡¹ Italiano</option>
    <option value="sq">ðŸ‡¦ðŸ‡± Shqip</option>
  </select>
</div>

<h1 data-i18n="my_listings">My Listings</h1>

<div class="list-container" id="listingsBox">
  <div class="empty-message" data-i18n="loading">Loading...</div>
</div>

<div id="pagination"></div>

<script>
/* ===========================================================
   LANGUAGE PACKS
=========================================================== */
const LANG = {
  en:{my_listings:"My Listings",loading:"Loading...",none:"You have no listings yet",edit:"Edit",open:"Open"},
  bs:{my_listings:"Moji oglasi",loading:"UÄitavanje...",none:"Nemate nijedan oglas",edit:"Uredi",open:"Otvori"},
  de:{my_listings:"Meine Anzeigen",loading:"Lade...",none:"Du hast noch keine Anzeigen",edit:"Bearbeiten",open:"Ã–ffnen"},
  fr:{my_listings:"Mes annonces",loading:"Chargement...",none:"Vous n'avez pas encore d'annonces",edit:"Modifier",open:"Ouvrir"},
  es:{my_listings:"Mis anuncios",loading:"Cargando...",none:"No tienes anuncios",edit:"Editar",open:"Abrir"},
  it:{my_listings:"I miei annunci",loading:"Caricamento...",none:"Non hai annunci",edit:"Modifica",open:"Apri"},
  sq:{my_listings:"Njoftimet e mia",loading:"Duke u ngarkuar...",none:"Nuk keni asnjÃ« njoftim",edit:"PÃ«rpuno",open:"Hap"}
};

function applyLanguage(lang){
  localStorage.setItem("lang",lang);
  const d = LANG[lang];

  // Text
  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const key = el.getAttribute("data-i18n");
    if(d[key]) el.textContent = d[key];
  });

  // Title update
  if(document.querySelector("title[data-i18n]")){
    const key = document.querySelector("title").getAttribute("data-i18n");
    document.title = d[key] + " â€“ Kaytas";
  }
}

function initLanguage(){
  let lang = localStorage.getItem("lang") || "en";
  document.getElementById("langSwitcher").value = lang;
  applyLanguage(lang);

  document.getElementById("langSwitcher").addEventListener("change",e=>{
    applyLanguage(e.target.value);
    renderPage();
  });
}

initLanguage();

/* ===========================================================
   LISTINGS
=========================================================== */
let ALL_LISTINGS=[];
let CURRENT_PAGE=1;
const ITEMS_PER_PAGE=20;

async function loadMyListings(){
  const token=localStorage.getItem("token");
  const box=document.getElementById("listingsBox");

  if(!token){
    box.innerHTML='<div class="empty-message">Login required</div>';
    return;
  }

  try{
    const res=await fetch("/api/listings/mine",{
      headers:{"Authorization":"Bearer "+token}
    });

    ALL_LISTINGS=await res.json();

    if(ALL_LISTINGS.length===0){
      box.innerHTML=`<div class="empty-message" data-i18n="none">${LANG[currentLang()].none}</div>`;
      return;
    }

    CURRENT_PAGE=1;
    renderPage();

  }catch(err){
    box.innerHTML='<div class="empty-message">Server error</div>';
  }
}

function currentLang(){
  return localStorage.getItem("lang") || "en";
}

function renderPage(){
  const box=document.getElementById("listingsBox");
  box.innerHTML="";

  const lang=currentLang();

  const start=(CURRENT_PAGE-1)*ITEMS_PER_PAGE;
  const end=start+ITEMS_PER_PAGE;
  const items=ALL_LISTINGS.slice(start,end);

  items.forEach(listing=>{
    const img = listing.images?.[0] || "";
    const id = listing._id;
    const coords = listing.location?.coordinates;

    const div=document.createElement("div");
    div.className="listing-card";

    div.innerHTML=`
      <img src="${img}">
      <div class="listing-info">
        <p class="listing-title">${listing.title}</p>
        <p class="listing-meta">${listing.price} kr â€“ ${listing.address || ""}</p>
      </div>

      <div class="miniMap" id="map_${id}"></div>

      <div class="listing-actions">
        <button class="edit-btn" onclick="editListing('${id}')">${LANG[lang].edit}</button>
        <button class="open-btn" onclick="openListing('${id}')">${LANG[lang].open}</button>
      </div>
    `;

    box.appendChild(div);

    if(coords){
      setTimeout(()=>renderMiniMap("map_"+id,coords),50);
    }
  });

  renderPagination();
}

/* MINI MAP RENDER */
function renderMiniMap(mapId,coords){
  const [lng,lat]=coords;

  // Destroy previous map instance if exists
  if (document.getElementById(mapId)._leaflet_id){
    document.getElementById(mapId).innerHTML = "";
  }

  const map = L.map(mapId,{
    zoomControl:false,
    attributionControl:false
  }).setView([lat,lng],13);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  L.marker([lat,lng]).addTo(map);
}

/* PAGINATION */
function renderPagination(){
  const totalPages=Math.ceil(ALL_LISTINGS.length/ITEMS_PER_PAGE);
  const pag=document.getElementById("pagination");
  pag.innerHTML="";

  if(totalPages<=1) return;

  if(CURRENT_PAGE>1){
    pag.innerHTML+=`<button onclick="gotoPage(${CURRENT_PAGE-1})">â€¹</button>`;
  }

  pag.innerHTML+=`<span>${CURRENT_PAGE} / ${totalPages}</span>`;

  if(CURRENT_PAGE<totalPages){
    pag.innerHTML+=`<button onclick="gotoPage(${CURRENT_PAGE+1})">â€º</button>`;
  }
}

function gotoPage(n){
  CURRENT_PAGE=n;
  renderPage();
}

function editListing(id){
  window.location.href="/create-listing.html?edit="+id;
}

function openListing(id){
  window.location.href="/listing.html?id="+id;
}

loadMyListings();
</script>

</body>
</html>
