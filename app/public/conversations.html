<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mina konversationer – Kaytas</title>
  <link rel="stylesheet" href="style.css">

  <style>
    body { margin: 0; font-family: Arial, sans-serif; background:#f5f6f8; }

    /* GLOBAL WRAPPER */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 16px;
    }

    /* HEADER ALIGNMENT */
    header {
      background:#fff;
      padding:15px 20px;
      box-shadow:0 2px 6px rgba(0,0,0,0.05);
      display:flex;
      justify-content:space-between;
      align-items:center;
      position:sticky;
      top:0;
      z-index:20;
    }

    header .logo {
      font-size:22px;
      font-weight:bold;
      cursor:pointer;
    }

    header a {
      margin-left:18px;
      text-decoration:none;
      color:#333;
      font-size:15px;
    }

    /* CHAT LAYOUT */
    .chat-wrapper {
      display:flex;
      gap:18px;
      margin-top:20px;
      height: calc(100vh - 110px);
      min-height:500px;
    }

    /* LEFT PANEL – LIST */
    .chat-list {
      width:32%;
      background:#fff;
      border-radius:10px;
      overflow-y:auto;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);
    }

    .chat-item {
      padding:14px;
      display:flex;
      gap:12px;
      border-bottom:1px solid #f0f0f0;
      cursor:pointer;
      align-items:center;
    }

    .chat-item:hover { background:#f7f9fc; }
    .chat-item.active { background:#e8f0ff; }

    .avatar {
      width:42px;
      height:42px;
      border-radius:50%;
      background:#d0d7df;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:bold;
      color:#444;
    }

    .chat-meta { flex:1; min-width:0; }
    .chat-name { font-weight:bold; font-size:15px; }
    .chat-preview { font-size:13px; color:#666; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .chat-ad { font-size:12px; color:#1976d2; }

    /* RIGHT PANEL */
    .chat-box {
      flex:1;
      display:flex;
      flex-direction:column;
      background:#fff;
      border-radius:10px;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);
    }

    .chat-header {
      padding:14px 18px;
      border-bottom:1px solid #eee;
      font-size:18px;
      font-weight:bold;
    }

    .messages {
      flex:1;
      overflow-y:auto;
      padding:20px;
      background:linear-gradient(#fbfbfd,#f5f6f8);
    }

    .bubble {
      max-width:65%;
      padding:12px;
      border-radius:12px;
      margin-bottom:10px;
      font-size:14px;
      line-height:1.4;
    }

    .me {
      margin-left:auto;
      background:#1976d2;
      color:#fff;
      border-bottom-right-radius:6px;
    }

    .them {
      background:#fff;
      border:1px solid #ddd;
      border-bottom-left-radius:6px;
    }

    /* INPUT BAR */
    .chat-input {
      padding:12px;
      display:flex;
      gap:10px;
      border-top:1px solid #eee;
    }

    .chat-input input {
      flex:1;
      padding:10px;
      border-radius:6px;
      border:1px solid #ccc;
    }

    .chat-input button {
      padding:10px 16px;
      background:#1976d2;
      color:#fff;
      border:none;
      border-radius:6px;
      cursor:pointer;
      font-weight:bold;
    }

    @media(max-width:900px) {
      .chat-wrapper { flex-direction:column; }
      .chat-list { width:100%; height:45%; }
      .chat-box { height:55%; }
    }
  </style>
</head>

<body>

<header>
  <div class="logo" onclick="location.href='/'">Kaytas</div>
  <nav>
    <a href="/">Home</a>
    <a href="/favorites.html">Favorites</a>
    <a href="/chat.html" class="active">Messages</a>
  </nav>
</header>

<div class="container">

  <div class="chat-wrapper">

    <!-- LEFT SIDE -->
    <div class="chat-list" id="conversationList">
      <p style="padding:18px;color:#777;">Laddar konversationer...</p>
    </div>

    <!-- RIGHT SIDE -->
    <div class="chat-box">

      <div class="chat-header" id="chatHeader">
        Välj en konversation
      </div>

      <div class="messages" id="messagesBox">
        <p style="color:#777;">Ingen konversation vald.</p>
      </div>

      <div class="chat-input">
        <input id="messageInput" type="text" placeholder="Skriv ett meddelande…">
        <button id="sendBtn">Skicka</button>
      </div>

    </div>

  </div>

</div>

<script>
  let selectedUser = null;
  let selectedAd = null;
  let selectedName = "";
  let selectedAdTitle = "";

  const token = localStorage.getItem("token");

  if (!token) {
    window.location.href = "/login.html?redirect=/chat.html";
  }

  function auth() {
    return { "Authorization": "Bearer " + token };
  }

  /* ===== LOAD CONVERSATIONS ===== */
  async function loadConversations() {
    const res = await fetch("/api/messages/conversations", { headers: auth() });
    const convos = await res.json();
    renderConversations(convos);
  }

  function renderConversations(list) {
    const box = document.getElementById("conversationList");

    if (!list || list.length === 0) {
      box.innerHTML = "<p style='padding:20px;color:#777;'>Inga konversationer.</p>";
      return;
    }

    box.innerHTML = "";

    list.forEach(c => {
      const other = c._id.otherUser;
      const ad = c.adId;

      const item = document.createElement("div");
      item.className = "chat-item";
      item.onclick = () => openConv(other._id, ad._id, other.name, ad.title);

      item.innerHTML = `
        <div class="avatar">${(other.name || "?").charAt(0)}</div>
        <div class="chat-meta">
          <div class="chat-name">${other.name}</div>
          <div class="chat-preview">${c.lastMessage || "No messages yet"}</div>
          <div class="chat-ad">${ad.title}</div>
        </div>
      `;

      box.appendChild(item);
    });
  }

  /* ===== OPEN CONVERSATION ===== */
  async function openConv(userId, adId, name, adTitle) {
    selectedUser = userId;
    selectedAd = adId;
    selectedName = name;
    selectedAdTitle = adTitle;

    document.getElementById("chatHeader").textContent = `${name} – ${adTitle}`;

    const res = await fetch(`/api/messages/thread/${userId}/${adId}`, { headers: auth() });
    const msgs = await res.json();

    const box = document.getElementById("messagesBox");
    box.innerHTML = "";

    msgs.forEach(m => {
      const sender = typeof m.sender === "string" ? m.sender : m.sender._id;
      const me = sender === getMyId();

      const div = document.createElement("div");
      div.className = `bubble ${me ? "me" : "them"}`;
      div.textContent = m.content;
      box.appendChild(div);
    });

    box.scrollTop = box.scrollHeight;
  }

  /* SEND */
  document.getElementById("sendBtn").onclick = send;

  async function send() {
    const text = document.getElementById("messageInput").value.trim();
    if (!text || !selectedUser) return;

    await fetch("/api/messages/send", {
      method:"POST",
      headers: { ...auth(), "Content-Type":"application/json" },
      body: JSON.stringify({ receiverId: selectedUser, adId: selectedAd, content:text })
    });

    document.getElementById("messageInput").value = "";
    openConv(selectedUser, selectedAd, selectedName, selectedAdTitle);
  }

  function getMyId() {
    const payload = JSON.parse(atob(token.split('.')[1]));
    return payload.id;
  }

  loadConversations();
</script>

</body>
</html>
