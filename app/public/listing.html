<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title data-i18n="page_title">Listing â€“ Kaytas</title>
  <link rel="stylesheet" href="style.css">

  <!-- MAP -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f4f4f4; }

    /* Language box */
    #langBox {
      text-align: right;
      padding: 10px 16px 0 16px;
    }

    #langSwitcher {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    header {
      background:#fff;
      padding:12px 18px;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:4px;
    }
    header .logo { font-size:20px; font-weight:600; cursor:pointer; }
    header a { margin-left:10px; text-decoration:none; color:#333; }

    main { max-width:1100px; margin:20px auto; padding:16px; display:flex; gap:20px; }

    .gallery {
      flex:1 1 60%;
      background:#fff;
      padding:12px;
      border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.06);
      position:relative;
      overflow:hidden;
    }
    .gallery img {
      width:100%;
      height:520px;
      object-fit:cover;
      display:block;
      border-radius:6px;
    }

    .thumbs {
      display:flex;
      gap:8px;
      margin-top:10px;
      overflow-x:auto;
      padding-bottom:5px;
    }
    .thumbs img {
      width:80px;
      height:60px;
      object-fit:cover;
      border-radius:4px;
      cursor:pointer;
      opacity:0.9;
      border:2px solid transparent;
    }
    .thumbs img.active {
      border-color:#1976d2;
      opacity:1;
    }

    .arrow {
      position:absolute;
      top:50%;
      transform:translateY(-50%);
      background:#fff;
      border:none;
      padding:8px 10px;
      border-radius:4px;
      cursor:pointer;
    }
    .arrow.left { left:10px; }
    .arrow.right { right:10px; }

    .details {
      flex:1 1 40%;
      background:#fff;
      padding:16px;
      border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.06);
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .details h1 { margin:0 0 8px 0; font-size:22px; }

    .info p { margin:8px 0; font-size:15px; color:#333; }
    .small { color:#666; font-size:13px; }

    .actions { display:flex; gap:10px; margin-top:16px; }
    button { border:none; padding:10px 14px; border-radius:6px; cursor:pointer; font-size:15px; }
    .btn-primary { background:#1976d2; color:#fff; }
    .btn-fav { background:#f0c14b; }

    /* MAP BOX */
    #map {
      width: 100%;
      height: 260px;
      border-radius: 8px;
      margin-top: 18px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    @media (max-width:900px) {
      main { flex-direction:column; }
      .gallery img { height:320px; }
      #map { height:200px; }
    }
  </style>
</head>

<body>

<div id="langBox">
  <select id="langSwitcher">
    <option value="en">ðŸ‡¬ðŸ‡§ English</option>
    <option value="bs">ðŸ‡·ðŸ‡¸ Serbian (Latin)</option>
    <option value="de">ðŸ‡©ðŸ‡ª Deutsch</option>
    <option value="fr">ðŸ‡«ðŸ‡· FranÃ§ais</option>
    <option value="es">ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
    <option value="it">ðŸ‡®ðŸ‡¹ Italiano</option>
    <option value="sq">ðŸ‡¦ðŸ‡± Shqip</option>
  </select>
</div>

<div class="container">

<header>
  <div class="logo" onclick="location.href='/'">Kaytas</div>
  <div>
    <a href="/" data-i18n="nav_home">Home</a>
    <a href="/login.html" data-i18n="nav_login">Login</a>
  </div>
</header>

<main>

  <!-- LEFT: GALLERY -->
  <section class="gallery">
    <button class="arrow left" id="prevBtn">&lt;</button>
    <button class="arrow right" id="nextBtn">&gt;</button>

    <img id="mainImage" src="" alt="Listing image">
    <div id="thumbs" class="thumbs"></div>
  </section>

  <!-- RIGHT: DETAILS -->
  <aside class="details">
    <div>
      <h1 id="title"></h1>

      <div class="info">
        <p><strong data-i18n="price_label">Price:</strong> <span id="price"></span> kr</p>
        <p><strong data-i18n="address_label">Address:</strong> <span id="address"></span></p>
        <p class="small"><strong data-i18n="posted_label">Posted:</strong> <span id="createdAt"></span></p>
      </div>

      <div style="margin-top:12px;">
        <strong data-i18n="description_label">Description</strong>
        <p id="description"></p>
      </div>

      <!-- MAP SECTION -->
      <div id="map"></div>

    </div>

    <div>
      <div class="actions">
        <button id="favoriteBtn" class="btn-fav" data-fav="no" data-i18n="add_favorite">Add to favorites</button>
        <button id="contactBtn" class="btn-primary" data-i18n="contact_seller">Contact seller</button>
      </div>

      <div class="small" style="margin-top:10px;">
        <span data-i18n="listing_id_label">Listing ID:</span> <span id="listingId"></span>
      </div>
    </div>
  </aside>

</main>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* LANGUAGE SYSTEM                               */
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const LANG = {
  en: {
    page_title: "Listing â€“ Kaytas",
    nav_home: "Home",
    nav_login: "Login",
    price_label: "Price:",
    address_label: "Address:",
    posted_label: "Posted:",
    description_label: "Description",
    contact_seller: "Contact seller",
    add_favorite: "Add to favorites",
    remove_favorite: "Remove favorite",
    listing_id_label: "Listing ID:",
    no_listing: "No listing selected.",
    load_error: "Could not load listing.",
    location_popup: "Location"
  },
  bs: {
    page_title: "Oglas â€“ Kaytas",
    nav_home: "PoÄetna",
    nav_login: "Prijava",
    price_label: "Cijena:",
    address_label: "Adresa:",
    posted_label: "Objavljeno:",
    description_label: "Opis",
    contact_seller: "Kontaktiraj prodavca",
    add_favorite: "Dodaj u omiljene",
    remove_favorite: "Ukloni iz omiljenih",
    listing_id_label: "ID oglasa:",
    no_listing: "Nijedan oglas nije odabran.",
    load_error: "Nije moguÄ‡e uÄitati oglas.",
    location_popup: "Lokacija"
  },
  de: {
    page_title: "Anzeige â€“ Kaytas",
    nav_home: "Startseite",
    nav_login: "Login",
    price_label: "Preis:",
    address_label: "Adresse:",
    posted_label: "VerÃ¶ffentlicht:",
    description_label: "Beschreibung",
    contact_seller: "VerkÃ¤ufer kontaktieren",
    add_favorite: "Zu Favoriten hinzufÃ¼gen",
    remove_favorite: "Aus Favoriten entfernen",
    listing_id_label: "Anzeige-ID:",
    no_listing: "Keine Anzeige ausgewÃ¤hlt.",
    load_error: "Anzeige konnte nicht geladen werden.",
    location_popup: "Standort"
  },
  fr: {
    page_title: "Annonce â€“ Kaytas",
    nav_home: "Accueil",
    nav_login: "Connexion",
    price_label: "Prix :",
    address_label: "Adresse :",
    posted_label: "PubliÃ© :",
    description_label: "Description",
    contact_seller: "Contacter le vendeur",
    add_favorite: "Ajouter aux favoris",
    remove_favorite: "Retirer des favoris",
    listing_id_label: "ID de l'annonce :",
    no_listing: "Aucune annonce sÃ©lectionnÃ©e.",
    load_error: "Impossible de charger l'annonce.",
    location_popup: "Emplacement"
  },
  es: {
    page_title: "Anuncio â€“ Kaytas",
    nav_home: "Inicio",
    nav_login: "Iniciar sesiÃ³n",
    price_label: "Precio:",
    address_label: "DirecciÃ³n:",
    posted_label: "Publicado:",
    description_label: "DescripciÃ³n",
    contact_seller: "Contactar al vendedor",
    add_favorite: "AÃ±adir a favoritos",
    remove_favorite: "Quitar de favoritos",
    listing_id_label: "ID del anuncio:",
    no_listing: "NingÃºn anuncio seleccionado.",
    load_error: "No se pudo cargar el anuncio.",
    location_popup: "UbicaciÃ³n"
  },
  it: {
    page_title: "Annuncio â€“ Kaytas",
    nav_home: "Home",
    nav_login: "Accedi",
    price_label: "Prezzo:",
    address_label: "Indirizzo:",
    posted_label: "Pubblicato:",
    description_label: "Descrizione",
    contact_seller: "Contatta il venditore",
    add_favorite: "Aggiungi ai preferiti",
    remove_favorite: "Rimuovi dai preferiti",
    listing_id_label: "ID annuncio:",
    no_listing: "Nessun annuncio selezionato.",
    load_error: "Impossibile caricare l'annuncio.",
    location_popup: "Posizione"
  },
  sq: {
    page_title: "Shpallje â€“ Kaytas",
    nav_home: "Kryefaqja",
    nav_login: "Hyr",
    price_label: "Ã‡mimi:",
    address_label: "Adresa:",
    posted_label: "Publikuar:",
    description_label: "PÃ«rshkrimi",
    contact_seller: "Kontakto shitÃ«sin",
    add_favorite: "Shto tek tÃ« preferuarat",
    remove_favorite: "Hiq nga tÃ« preferuarat",
    listing_id_label: "ID e shpalljes:",
    no_listing: "AsnjÃ« shpallje e zgjedhur.",
    load_error: "Nuk mund tÃ« ngarkohet shpallja.",
    location_popup: "Vendndodhja"
  }
};

function currentLang() {
  return localStorage.getItem("lang") || "en";
}

function applyLanguage(lang) {
  if (!LANG[lang]) lang = "en";
  localStorage.setItem("lang", lang);
  const dict = LANG[lang];

  document.querySelectorAll("[data-i18n]").forEach(el => {
    const key = el.getAttribute("data-i18n");
    if (dict[key]) el.textContent = dict[key];
  });

  document.title = dict.page_title || "Listing â€“ Kaytas";

  // Update favorite & contact buttons text based on state
  const favBtn = document.getElementById("favoriteBtn");
  if (favBtn) {
    if (favBtn.dataset.fav === "yes") {
      favBtn.textContent = dict.remove_favorite;
    } else {
      favBtn.textContent = dict.add_favorite;
    }
  }
  const contactBtn = document.getElementById("contactBtn");
  if (contactBtn) contactBtn.textContent = dict.contact_seller;
}

function initLanguage() {
  let saved = currentLang();
  const switcher = document.getElementById("langSwitcher");
  if (switcher) {
    switcher.value = saved;
    switcher.addEventListener("change", e => {
      applyLanguage(e.target.value);
    });
  }
  applyLanguage(saved);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* LOGIN / DOM HELPERS                           */
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function requireLogin(redirectUrl) {
  const token = localStorage.getItem("token");
  if (!token) {
    window.location.href = "/login.html?redirect=" + encodeURIComponent(redirectUrl || window.location.href);
    return false;
  }
  return true;
}

function setText(id, text) {
  const el = document.getElementById(id);
  if (el) el.textContent = text || "";
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* GALLERY                                       */
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let images = [];
let currentIndex = 0;

const mainImage = document.getElementById("mainImage");
const thumbs = document.getElementById("thumbs");

function showImage(i) {
  if (images.length === 0) return;
  if (i < 0) i = images.length - 1;
  if (i >= images.length) i = 0;

  currentIndex = i;
  mainImage.src = images[currentIndex];

  thumbs.querySelectorAll("img").forEach((t, idx) =>
    t.classList.toggle("active", idx === currentIndex)
  );
}

document.getElementById("prevBtn").onclick = () => showImage(currentIndex - 1);
document.getElementById("nextBtn").onclick = () => showImage(currentIndex + 1);

let startX = 0;
mainImage.addEventListener("touchstart", e => startX = e.changedTouches[0].screenX);
mainImage.addEventListener("touchend", e => {
  const diff = e.changedTouches[0].screenX - startX;
  if (diff > 40) showImage(currentIndex - 1);
  if (diff < -40) showImage(currentIndex + 1);
});

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* MAP VARIABLES                                 */
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let map;
let marker;

/* Load listing */
let listingData = null;

async function loadListing() {
  const lang = currentLang();
  const id = new URLSearchParams(window.location.search).get("id");
  if (!id) {
    alert(LANG[lang].no_listing);
    location.href = "/";
    return;
  }

  try {
    const res = await fetch("/api/listings/" + id);
    if (!res.ok) throw new Error();

    listingData = await res.json();

    setText("title", listingData.title);
    setText("price", listingData.price);
    setText("address", listingData.address);
    setText("description", listingData.description);
    setText("listingId", listingData._id);
    setText("createdAt", listingData.createdAt ? new Date(listingData.createdAt).toLocaleString() : "");

    /* Gallery images */
    images = listingData.images?.length ? listingData.images : ["/uploads/default.jpg"];
    thumbs.innerHTML = images.map((src,i)=>`<img src="${src}" onclick="showImage(${i})">`).join("");
    showImage(0);

    updateFavoriteButton();
    loadMap();

  } catch {
    alert(LANG[lang].load_error);
    location.href = "/";
  }
}

/* MAP LOGIC */
function loadMap() {
  if (!listingData.location || !listingData.location.coordinates) return;

  const [lng, lat] = listingData.location.coordinates;
  const lang = currentLang();

  map = L.map("map").setView([lat, lng], 14);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19
  }).addTo(map);

  marker = L.marker([lat, lng]).addTo(map);
  marker.bindPopup(listingData.address || LANG[lang].location_popup).openPopup();
}

/* FAVORITES */
function getToken() { return localStorage.getItem("token"); }

async function updateFavoriteButton() {
  const btn = document.getElementById("favoriteBtn");
  const token = getToken();
  const lang = currentLang();

  if (!token) {
    btn.textContent = LANG[lang].add_favorite;
    btn.dataset.fav = "no";
    return;
  }

  try {
    const res = await fetch("/api/favorites", {
      headers: { Authorization:"Bearer " + token }
    });

    const favs = await res.json();
    const isFav = favs.some(f => f._id === listingData._id);

    btn.textContent = isFav ? LANG[lang].remove_favorite : LANG[lang].add_favorite;
    btn.dataset.fav = isFav ? "yes" : "no";

  } catch {
    btn.textContent = LANG[lang].add_favorite;
  }
}

document.getElementById("favoriteBtn").onclick = async function(e) {
  e.stopPropagation();
  if (!requireLogin(window.location.href)) return;

  const btn = this;
  const token = getToken();
  const lang = currentLang();
  const isFav = btn.dataset.fav === "yes";

  const res = await fetch("/api/favorites/" + listingData._id, {
    method: isFav ? "DELETE" : "POST",
    headers: { Authorization:"Bearer " + token }
  });

  if (res.ok) {
    btn.dataset.fav = isFav ? "no" : "yes";
    btn.textContent = isFav ? LANG[lang].add_favorite : LANG[lang].remove_favorite;
  }
};

/* Contact seller */
document.getElementById("contactBtn").onclick = function() {
  if (!requireLogin(window.location.href)) return;
  location.href = "/chat.html?adId=" + encodeURIComponent(listingData._id);
};

/* INIT */
initLanguage();
loadListing();
</script>

</div>
</body>
</html>
