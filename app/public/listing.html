<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Annons – Kaytas</title>
  <link rel="stylesheet" href="style.css">

  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f4f4f4; }
    header { background:#fff; padding:12px 18px; box-shadow:0 2px 6px rgba(0,0,0,0.08); display:flex; justify-content:space-between; align-items:center; }
    header .logo { font-size:20px; font-weight:600; cursor:pointer; }
    header a { margin-left:10px; text-decoration:none; color:#333; }

    main { max-width:1100px; margin:20px auto; padding:16px; display:flex; gap:20px; }

    .gallery { flex:1 1 60%; background:#fff; padding:12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.06); position:relative; overflow:hidden; }
    .gallery img { width:100%; height:520px; object-fit:cover; display:block; border-radius:6px; }

    .thumbs { display:flex; gap:8px; margin-top:10px; overflow-x:auto; padding-bottom:5px; }
    .thumbs img { width:80px; height:60px; object-fit:cover; border-radius:4px; cursor:pointer; opacity:0.9; border:2px solid transparent; }
    .thumbs img.active { border-color:#1976d2; opacity:1; }

    .arrow { position:absolute; top:50%; transform:translateY(-50%); background:#fff; border:none; padding:8px 10px; border-radius:4px; cursor:pointer; }
    .arrow.left { left:10px; }
    .arrow.right { right:10px; }

    .details { flex:1 1 40%; background:#fff; padding:16px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.06); display:flex; flex-direction:column; justify-content:space-between; }
    .details h1 { margin:0 0 8px 0; font-size:22px; }

    .info p { margin:8px 0; font-size:15px; color:#333; }
    .small { color:#666; font-size:13px; }

    .actions { display:flex; gap:10px; margin-top:16px; }
    button { border:none; padding:10px 14px; border-radius:6px; cursor:pointer; font-size:15px; }
    .btn-primary { background:#1976d2; color:#fff; }
    .btn-fav { background:#f0c14b; }

    @media (max-width:900px) {
      main { flex-direction:column; }
      .gallery img { height:320px; }
    }
  </style>
</head>

<body>
    <div class="container">

<header>
  <div class="logo" onclick="location.href='/'">Kaytas</div>
  <div>
    <a href="/">Home</a>
    <a href="/login.html">Login</a>
  </div>
</header>

<main>

  <!-- LEFT: GALLERY -->
  <section class="gallery">
    <button class="arrow left" id="prevBtn">&lt;</button>
    <button class="arrow right" id="nextBtn">&gt;</button>

    <img id="mainImage" src="" alt="Annonsbild">
    <div id="thumbs" class="thumbs"></div>
  </section>

  <!-- RIGHT: DETAILS -->
  <aside class="details">
    <div>
      <h1 id="title"></h1>

      <div class="info">
        <p><strong>Pris:</strong> <span id="price"></span> kr</p>
        <p><strong>Adress:</strong> <span id="address"></span></p>
        <p class="small"><strong>Upplagd:</strong> <span id="createdAt"></span></p>
      </div>

      <div style="margin-top:12px;">
        <strong>Beskrivning</strong>
        <p id="description"></p>
      </div>
    </div>

    <div>
      <div class="actions">
        <button id="favoriteBtn" class="btn-fav">Add to favorites</button>
        <button id="contactBtn" class="btn-primary">Kontakta säljaren</button>
      </div>

      <div class="small" style="margin-top:10px;">
        Annons-ID: <span id="listingId"></span>
      </div>
    </div>
  </aside>

</main>

<script>
/* Redirect to login if needed */
function requireLogin(redirectUrl) {
  const token = localStorage.getItem("token");
  if (!token) {
    window.location.href = "/login.html?redirect=" + encodeURIComponent(redirectUrl || window.location.href);
    return false;
  }
  return true;
}

/* DOM helpers */
function setText(id, text) {
  const el = document.getElementById(id);
  if (el) el.textContent = text || "";
}

/* Gallery state */
let images = [];
let currentIndex = 0;

const mainImage = document.getElementById("mainImage");
const thumbs = document.getElementById("thumbs");

function showImage(i) {
  if (images.length === 0) return;
  if (i < 0) i = images.length - 1;
  if (i >= images.length) i = 0;

  currentIndex = i;
  mainImage.src = images[currentIndex];

  const ts = thumbs.querySelectorAll("img");
  ts.forEach((t, idx) => t.classList.toggle("active", idx === currentIndex));
}

document.getElementById("prevBtn").onclick = () => showImage(currentIndex - 1);
document.getElementById("nextBtn").onclick = () => showImage(currentIndex + 1);

/* Touch swipe */
let startX = 0;
mainImage.addEventListener("touchstart", e => {
  startX = e.changedTouches[0].screenX;
});
mainImage.addEventListener("touchend", e => {
  const endX = e.changedTouches[0].screenX;
  const diff = endX - startX;
  if (diff > 40) showImage(currentIndex - 1);
  if (diff < -40) showImage(currentIndex + 1);
});

/* Load listing data */
let listingData = null;

async function loadListing() {
  const id = new URLSearchParams(window.location.search).get("id");
  if (!id) {
    alert("Ingen annons vald.");
    location.href = "/";
    return;
  }

  try {
    const res = await fetch("/api/listings/" + id);
    if (!res.ok) throw new Error();

    listingData = await res.json();

    setText("title", listingData.title);
    setText("price", listingData.price);
    setText("address", listingData.address);
    setText("description", listingData.description);
    setText("listingId", listingData._id);
    setText("createdAt", listingData.createdAt ? new Date(listingData.createdAt).toLocaleString() : "");

    images = Array.isArray(listingData.images) && listingData.images.length > 0 
      ? listingData.images 
      : ["/uploads/default.jpg"];

    thumbs.innerHTML = "";
    images.forEach((src, i) => {
      const t = document.createElement("img");
      t.src = src;
      t.onclick = () => showImage(i);
      thumbs.appendChild(t);
    });

    showImage(0);
    updateFavoriteButton();

  } catch {
    alert("Kunde inte hämta annonsen.");
    location.href = "/";
  }
}

/* Favorite logic */
function getToken() {
  return localStorage.getItem("token");
}

async function updateFavoriteButton() {
  const btn = document.getElementById("favoriteBtn");
  const token = getToken();

  if (!token) {
    btn.textContent = "Add to favorites";
    btn.dataset.fav = "no";
    return;
  }

  try {
    const res = await fetch("/api/favorites", {
      headers: { Authorization: "Bearer " + token }
    });

    if (!res.ok) throw new Error();

    const favs = await res.json();
    const isFav = favs.some(f => f._id === listingData._id);

    btn.textContent = isFav ? "Remove favorite" : "Add to favorites";
    btn.dataset.fav = isFav ? "yes" : "no";

  } catch {
    btn.textContent = "Add to favorites";
    btn.dataset.fav = "no";
  }
}

document.getElementById("favoriteBtn").onclick = async function(e) {
  e.stopPropagation();
  if (!requireLogin(window.location.href)) return;

  const btn = this;
  const token = getToken();
  const listingId = listingData._id;
  const isFav = btn.dataset.fav === "yes";

  const url = "/api/favorites/" + listingId;
  const method = isFav ? "DELETE" : "POST";

  try {
    const res = await fetch(url, {
      method,
      headers: { Authorization: "Bearer " + token }
    });

    if (res.ok) {
      btn.textContent = isFav ? "Add to favorites" : "Remove favorite";
      btn.dataset.fav = isFav ? "no" : "yes";
    }

  } catch {
    alert("Kunde inte ändra favorit.");
  }
};

/* Contact seller */
document.getElementById("contactBtn").onclick = function() {
  if (!requireLogin(window.location.href)) return;
  location.href = "/chat.html?adId=" + encodeURIComponent(listingData._id);
};

/* Init */
loadListing();

</script>

    </div> <!-- end container -->
</body>
</html>
