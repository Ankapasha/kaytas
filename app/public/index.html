<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kaytas</title>
  <link rel="stylesheet" href="style.css">

  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f4f4f4; }

    header {
      background:#ffffff;
      padding:15px 20px;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
      display:flex;
      justify-content:space-between;
      align-items:center;
      position:sticky;
      top:0;
      z-index:10;
    }

    .logo { font-size:24px; font-weight:bold; }

    nav a {
      margin-left:20px;
      text-decoration:none;
      color:#333;
      font-size:15px;
    }

    nav a:hover { text-decoration:underline; }

    .listings {
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(260px, 1fr));
      gap:20px;
      max-width:1200px;
      margin:25px auto;
      padding:10px;
    }

    .listing-card {
      background:#fff;
      padding:10px;
      border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
      cursor:pointer;
      transition:transform .1s;
    }

    .listing-card:hover { transform:scale(1.02); }

    .listing-card img {
      width:100%;
      height:160px;
      object-fit:cover;
      border-radius:6px;
    }

    .fav-btn {
      margin-top:10px;
      padding:8px;
      width:100%;
      border:none;
      border-radius:6px;
      cursor:pointer;
    }

    #pagination {
      text-align:center;
      margin:20px;
    }

    #topControls {
      max-width:1200px;
      margin:20px auto;
      display:flex;
      gap:10px;
      padding:0 10px;
    }

    #searchInput {
      flex:1;
      padding:10px;
      border-radius:6px;
      border:1px solid #ccc;
    }

    .btn {
      padding:10px 15px;
      border:none;
      border-radius:6px;
      cursor:pointer;
    }

    #filterPanel, #sortPanel {
      max-width:1200px;
      margin:10px auto;
      padding:10px;
      background:#fff;
      border-radius:8px;
      display:none;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
    }

  </style>
</head>

<body>
    <div class="container">

<header>
  <div class="logo">Kaytas</div>
  <nav id="navLinks"></nav>
</header>

<div id="topControls">
  <input type="text" id="searchInput" placeholder="Search by address">
  <button id="searchBtn" class="btn">Search</button>
  <button id="filterBtn" class="btn">Filter</button>
  <button id="sortBtn" class="btn">Sort</button>
</div>

<div id="filterPanel">
  <h3>Filter</h3>
  <label>Type:</label>
  <input id="filterType" type="text">

  <label>Min Price:</label>
  <input id="filterMinPrice" type="number">

  <label>Max Price:</label>
  <input id="filterMaxPrice" type="number">

  <label>Address:</label>
  <input id="filterLocation" type="text">

  <button id="applyFilterBtn" class="btn">Apply</button>
</div>

<div id="sortPanel">
  <h3>Sort</h3>
  <button class="sort-option" data-sort="price_asc">Price Rising</button>
  <button class="sort-option" data-sort="price_desc">Price Falling</button>
  <button class="sort-option" data-sort="new">Newest</button>
  <button class="sort-option" data-sort="old">Oldest</button>
</div>

<div class="listings"></div>
<div id="pagination"></div>


<script>

/* HEADER */
(function() {
    const token = localStorage.getItem("token");
    const nav = document.getElementById("navLinks");

    if (!token) {
        nav.innerHTML = 
            '<a href="/">Home</a>' +
            '<a href="/">Buy</a>' +
            '<a href="/">Rent</a>' +
            '<a href="/login.html">Login</a>';
    } else {
        nav.innerHTML = 
            '<a href="/">Home</a>' +
            '<a href="/">Buy</a>' +
            '<a href="/">Rent</a>' +
            '<a href="/favorites.html">Favorites</a>' +
            '<a href="/my-listings.html">My Listings</a>' +
            '<a href="/chat.html">Chat</a>' +
            '<a href="/dashboard.html">Profile</a>' +
            '<a href="#" id="logoutBtn">Logout</a>';

        document.getElementById("logoutBtn").onclick = function() {
            localStorage.removeItem("token");
            window.location.href = "/";
        };
    }
})();

/* REDIRECT */
function requireLogin(redirectUrl) {
    if (!redirectUrl) redirectUrl = window.location.href;
    const token = localStorage.getItem("token");
    if (!token) {
        window.location.href = "/login.html?redirect=" + encodeURIComponent(redirectUrl);
        return false;
    }
    return true;
}

/* GLOBALS */
let ALL_LISTINGS = [];
let CURRENT_PAGE = 1;
const ITEMS_PER_PAGE = 20;
const listingsContainer = document.querySelector(".listings");

function getToken() {
  return localStorage.getItem("token");
}

/* FETCH FAVORITES */
async function fetchFavorites() {
    const token = getToken();
    if (!token) return [];

    try {
        const res = await fetch("/api/favorites", {
            headers: { Authorization: "Bearer " + token }
        });

        if (!res.ok) return [];
        const data = await res.json();
        return data.map(function(f) { return f._id; });

    } catch (e) {
        return [];
    }
}

/* RENDER PAGE */
function renderPage() {
    listingsContainer.innerHTML = "";

    const start = (CURRENT_PAGE - 1) * ITEMS_PER_PAGE;
    const end = start + ITEMS_PER_PAGE;
    const pageListings = ALL_LISTINGS.slice(start, end);

    if (pageListings.length === 0) {
        listingsContainer.innerHTML = "<p>No listings found</p>";
        return;
    }

    fetchFavorites().then(function(favoriteIds) {
        pageListings.forEach(function(listing) {

            const isFavorite = favoriteIds.includes(listing._id);

            const card = document.createElement("div");
            card.className = "listing-card";

            card.innerHTML =
                '<img src="' + (listing.images && listing.images[0] ? listing.images[0] : '') + '">' +
                '<h3>' + listing.title + '</h3>' +
                '<p>Price: ' + listing.price + ' kr</p>' +
                '<p>Address: ' + (listing.address || '') + '</p>' +
                '<button class="fav-btn" data-id="' + listing._id + '">' +
                (isFavorite ? "Favorite" : "Add to favorites") +
                '</button>';

            card.addEventListener("click", function(e) {
                if (e.target.classList.contains("fav-btn")) return;
                window.location.href = "/listing.html?id=" + listing._id;
            });

            listingsContainer.appendChild(card);
        });

        addFavoriteButtonEvents();
    });

    renderPaginationControls();
}

/* PAGINATION */
function renderPaginationControls() {
    const totalPages = Math.ceil(ALL_LISTINGS.length / ITEMS_PER_PAGE);
    const container = document.getElementById("pagination");

    if (totalPages <= 1) {
        container.innerHTML = "";
        return;
    }

    let html = "";

    if (CURRENT_PAGE > 1)
        html += '<button onclick="gotoPage(' + (CURRENT_PAGE - 1) + ')">Previous</button> ';

    html += '<strong>Page ' + CURRENT_PAGE + ' / ' + totalPages + '</strong> ';

    if (CURRENT_PAGE < totalPages)
        html += '<button onclick="gotoPage(' + (CURRENT_PAGE + 1) + ')">Next</button>';

    container.innerHTML = html;
}

function gotoPage(n) {
    CURRENT_PAGE = n;
    renderPage();
}

/* LOAD LISTINGS */
async function loadListings() {
    listingsContainer.innerHTML = "<p>Loading...</p>";

    try {
        const res = await fetch("/api/listings");
        const listings = await res.json();

        ALL_LISTINGS = listings;
        CURRENT_PAGE = 1;
        renderPage();

    } catch (err) {
        listingsContainer.innerHTML = "<p>Error loading listings</p>";
    }
}

/* FAVORITE BUTTONS */
function addFavoriteButtonEvents() {

    const buttons = document.querySelectorAll(".fav-btn");

    buttons.forEach(function(btn) {

        btn.addEventListener("click", async function (e) {
            e.stopPropagation();

            const listingId = this.getAttribute("data-id");

            if (!requireLogin()) return;

            const token = getToken();

            if (this.textContent.indexOf("Add") !== -1) {

                const res = await fetch("/api/favorites/" + listingId, {
                    method: "POST",
                    headers: { Authorization: "Bearer " + token }
                });

                if (res.ok) this.textContent = "Favorite";

            } else {

                const res = await fetch("/api/favorites/" + listingId, {
                    method: "DELETE",
                    headers: { Authorization: "Bearer " + token }
                });

                if (res.ok) this.textContent = "Add to favorites";
            }
        });
    });
}

/* SEARCH */
async function searchListings() {
    const query = document.getElementById("searchInput").value.trim();

    if (query === "") {
        loadListings();
        return;
    }

    listingsContainer.innerHTML = "<p>Loading...</p>";

    try {
        const res = await fetch("/api/listings?address=" + encodeURIComponent(query));
        const listings = await res.json();

        ALL_LISTINGS = listings;
        CURRENT_PAGE = 1;
        renderPage();

    } catch (e) {
        listingsContainer.innerHTML = "<p>Error searching</p>";
    }
}

document.getElementById("searchBtn").addEventListener("click", searchListings);
document.getElementById("searchInput").addEventListener("keypress", function(e) {
    if (e.key === "Enter") searchListings();
});

/* FILTER */
document.getElementById("filterBtn").addEventListener("click", function() {
    const panel = document.getElementById("filterPanel");
    panel.style.display =
        (panel.style.display === "none" || panel.style.display === "")
        ? "block"
        : "none";
});

document.getElementById("applyFilterBtn").addEventListener("click", applyFilters);

async function applyFilters() {
    const type = document.getElementById("filterType").value.trim();
    const minPrice = document.getElementById("filterMinPrice").value.trim();
    const maxPrice = document.getElementById("filterMaxPrice").value.trim();
    const address = document.getElementById("filterLocation").value.trim();

    let url = "/api/listings?";

    if (type) url += "type=" + encodeURIComponent(type) + "&";
    if (minPrice) url += "minPrice=" + encodeURIComponent(minPrice) + "&";
    if (maxPrice) url += "maxPrice=" + encodeURIComponent(maxPrice) + "&";
    if (address) url += "address=" + encodeURIComponent(address) + "&";

    listingsContainer.innerHTML = "<p>Loading filtered results...</p>";

    try {
        const res = await fetch(url);
        const listings = await res.json();

        ALL_LISTINGS = listings;
        CURRENT_PAGE = 1;
        renderPage();

    } catch (e) {
        listingsContainer.innerHTML = "<p>Error filtering</p>";
    }
}

/* SORT */
document.getElementById("sortBtn").addEventListener("click", function() {
    const panel = document.getElementById("sortPanel");
    panel.style.display =
        (panel.style.display === "none" || panel.style.display === "")
        ? "block"
        : "none";
});

document.querySelectorAll(".sort-option").forEach(function(btn) {
    btn.addEventListener("click", function() {
        applySort(btn.getAttribute("data-sort"));
    });
});

async function applySort(sortType) {
    listingsContainer.innerHTML = "<p>Sorting...</p>";

    let url = "/api/listings?";

    if (sortType === "price_asc") url += "sort=price_asc";
    if (sortType === "price_desc") url += "sort=price_desc";
    if (sortType === "new") url += "sort=new";
    if (sortType === "old") url += "sort=old";

    try {
        const res = await fetch(url);
        const listings = await res.json();

        ALL_LISTINGS = listings;
        CURRENT_PAGE = 1;
        renderPage();

    } catch (e) {
        listingsContainer.innerHTML = "<p>Error sorting</p>";
    }
}

/* INIT */
loadListings();

</script>

    </div> <!-- end container -->
</body>
</html>
